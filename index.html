<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sparkcoin</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* Стили остаются такими же, только меняем логику */
    </style>
</head>
<body>
    <div class="container">
        <!-- HTML разметка остается такой же -->
    </div>

    <script>
        const tg = window.Telegram.WebApp;
        let userData = {};
        let lastUpdateTime = Date.now();
        let accumulatedIncome = 0;
        
        // Базовые улучшения
        const baseUpgrades = {
            basic_miner: { price: 10, count: 0, effect: 0.000000001 },
            click_booster: { price: 50, level: 1, multiplier: 1 },
            cpu: { price: 100, level: 1, multiplier: 1 },
            mining_farm: { price: 500, count: 0, effect: 0.0000001 }
        };

        let upgrades = JSON.parse(JSON.stringify(baseUpgrades));

        // Инициализация
        tg.expand();
        tg.enableClosingConfirmation();
        
        // Загрузка данных
        function loadUserData() {
            const savedData = localStorage.getItem('sparkcoin_user_data');
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('user_id') || tg.initDataUnsafe?.user?.id || Math.random().toString(36).substr(2, 9);
            const username = urlParams.get('username') || tg.initDataUnsafe?.user?.first_name || 'Игрок';
            
            if (savedData) {
                userData = JSON.parse(savedData);
                // Восстанавливаем улучшения
                if (userData.upgrades) {
                    upgrades = userData.upgrades;
                }
            } else {
                userData = {
                    userId: userId,
                    username: username,
                    balance: 10.00,
                    totalEarned: 10.00,
                    totalClicks: 0,
                    lastUpdate: Date.now(),
                    upgrades: JSON.parse(JSON.stringify(upgrades))
                };
            }
            
            updateShopUI();
            updateUI();
        }
        
        // Сохранение данных
        function saveUserData() {
            userData.upgrades = JSON.parse(JSON.stringify(upgrades));
            userData.lastUpdate = Date.now();
            localStorage.setItem('sparkcoin_user_data', JSON.stringify(userData));
            sendPlayerData();
        }
        
        // Расчет силы клика (ТЕПЕРЬ РАБОТАЕТ ПРАВИЛЬНО)
        function calculateClickPower() {
            let basePower = 0.000000001; // Базовая сила клика
            
            // Умножаем на множитель улучшения кликера
            if (upgrades.click_booster && upgrades.click_booster.level > 1) {
                basePower *= upgrades.click_booster.level;
            }
            
            return basePower;
        }
        
        // Расчет скорости майнинга (ТЕПЕРЬ РАБОТАЕТ ПРАВИЛЬНО)
        function calculateMiningSpeed() {
            let baseSpeed = 0.000000001; // Базовая скорость
            
            // Добавляем эффект от базовых майнеров
            baseSpeed += upgrades.basic_miner.count * upgrades.basic_miner.effect;
            
            // Добавляем эффект от ферм майнинга
            baseSpeed += upgrades.mining_farm.count * upgrades.mining_farm.effect;
            
            // Умножаем на множитель процессора
            if (upgrades.cpu && upgrades.cpu.level > 1) {
                baseSpeed *= upgrades.cpu.level;
            }
            
            return baseSpeed;
        }
        
        // Клик по монетке (ТЕПЕРЬ ПРАВИЛЬНО ДОБАВЛЯЕТ ДЕНЬГИ)
        function clickCoin() {
            const clickPower = calculateClickPower();
            userData.balance += clickPower;
            userData.totalEarned += clickPower;
            userData.totalClicks++;
            
            updateUI();
            saveUserData();
            
            // Показываем анимацию клика (без уведомления)
            const coin = document.querySelector('.click-coin');
            coin.style.transform = 'scale(0.95)';
            setTimeout(() => {
                coin.style.transform = 'scale(1)';
            }, 100);
        }
        
        // Покупка улучшения
        function buyUpgrade(upgradeType) {
            const upgrade = upgrades[upgradeType];
            if (userData.balance >= upgrade.price) {
                userData.balance -= upgrade.price;
                
                if (upgradeType === 'basic_miner' || upgradeType === 'mining_farm') {
                    upgrade.count++;
                    // Увеличиваем цену для следующей покупки
                    upgrade.price = Math.floor(upgrade.price * 1.3);
                } else {
                    upgrade.level++;
                    upgrade.price = Math.floor(upgrade.price * 1.5);
                }
                
                updateUI();
                updateShopUI();
                saveUserData();
                
                // Показываем сообщение о покупке
                showTempMessage(`✅ Улучшение куплено!`);
            } else {
                showTempMessage('❌ Недостаточно средств', true);
            }
        }
        
        // Временное сообщение (без уведомления)
        function showTempMessage(message, isError = false) {
            const tempMsg = document.createElement('div');
            tempMsg.style.cssText = `
                position: fixed;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                background: ${isError ? '#f44336' : '#4CAF50'};
                color: white;
                padding: 10px 20px;
                border-radius: 5px;
                z-index: 1000;
                font-size: 14px;
            `;
            tempMsg.textContent = message;
            document.body.appendChild(tempMsg);
            
            setTimeout(() => {
                document.body.removeChild(tempMsg);
            }, 1000);
        }
        
        // Обновление интерфейса магазина
        function updateShopUI() {
            // Обновляем счетчики улучшений
            document.getElementById('basic_miner_count').textContent = upgrades.basic_miner.count;
            document.getElementById('click_booster_level').textContent = upgrades.click_booster.level;
            document.getElementById('cpu_level').textContent = upgrades.cpu.level;
            document.getElementById('mining_farm_count').textContent = upgrades.mining_farm.count;
            
            // Обновляем цены и доступность кнопок
            document.querySelectorAll('.shop-item').forEach(item => {
                const title = item.querySelector('.shop-title').textContent;
                let upgradeType = '';
                
                if (title.includes('Базовый майнер')) upgradeType = 'basic_miner';
                if (title.includes('Улучшенный кликер')) upgradeType = 'click_booster';
                if (title.includes('Процессор i9')) upgradeType = 'cpu';
                if (title.includes('Ферма майнинга')) upgradeType = 'mining_farm';
                
                if (upgradeType) {
                    const priceElement = item.querySelector('.shop-price');
                    priceElement.textContent = `Цена: ${upgrades[upgradeType].price} S`;
                    
                    const button = item.querySelector('.buy-button');
                    button.disabled = userData.balance < upgrades[upgradeType].price;
                }
            });
        }
        
        // ОБНОВЛЕНИЕ ИНТЕРФЕЙСА С ПРАВИЛЬНОЙ ЭКОНОМИКОЙ
        function updateUI() {
            const currentTime = Date.now();
            const elapsedSeconds = (currentTime - lastUpdateTime) / 1000;
            
            // Авто-майнинг: накапливаем доход за прошедшее время
            const miningSpeed = calculateMiningSpeed();
            accumulatedIncome += miningSpeed * elapsedSeconds;
            
            // Добавляем накопленный доход к балансу (каждые 0.0000001 S)
            if (accumulatedIncome >= 0.0000001) {
                userData.balance += accumulatedIncome;
                userData.totalEarned += accumulatedIncome;
                accumulatedIncome = 0; // Сбрасываем накопленное
            }
            
            lastUpdateTime = currentTime;
            
            // Обновляем отображение
            const clickPower = calculateClickPower();
            document.getElementById('balanceValue').textContent = userData.balance.toFixed(9) + ' S';
            document.getElementById('clickValue').textContent = clickPower.toFixed(9);
            document.getElementById('clickSpeed').textContent = clickPower.toFixed(9) + ' S/сек';
            document.getElementById('mineSpeed').textContent = miningSpeed.toFixed(9) + ' S/сек';
        }
        
        // Остальные функции остаются без изменений...
        
        // Инициализация
        function initializeApp() {
            loadUserData();
            
            // Обновление интерфейса каждые 100мс
            setInterval(updateUI, 100);
            // Авто-сохранение каждые 10 секунд
            setInterval(saveUserData, 10000);
            
            tg.ready();
        }

        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
